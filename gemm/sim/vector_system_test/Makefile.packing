# Makefile for Result Packing Testbench
# Tests the circular buffer functionality of result_fifo_to_simple_bram.sv
# Updated: Oct 31, 2025 for circular buffer optimization

TB = tb_result_packing
TOP = tb_result_packing
WORK = work_packing
LOG_FILE = packing_sim.log

# Riviera-PRO commands
VLIB = vlib
VLOG = vlog
VSIM = vsim

# Source directories
GEMM_RTL = ../../src/rtl
GEMM_INC = ../../src/include

# Include paths
INCLUDES = +incdir+$(GEMM_INC)

# Testbench source
TB_SOURCE = $(TB).sv

# RTL sources (only what we need)
RTL_SOURCES = \
	$(GEMM_RTL)/result_fifo_to_simple_bram.sv

.PHONY: all clean run compile

all: run

# Create work library
$(WORK):
	@echo "Creating work library..." | tee $(LOG_FILE)
	@$(VLIB) $(WORK) >> $(LOG_FILE) 2>&1

# Compile
compile: $(WORK)
	@echo "======================================================================" | tee -a $(LOG_FILE)
	@echo "  Compilation Started: $$(date)" | tee -a $(LOG_FILE)
	@echo "======================================================================" | tee -a $(LOG_FILE)
	@echo "Compiling packages..." | tee -a $(LOG_FILE)
	@$(VLOG) -sv $(INCLUDES) -work $(WORK) \
		$(GEMM_INC)/gemm_pkg.sv >> $(LOG_FILE) 2>&1 || \
		(echo "ERROR: Package compilation failed. See $(LOG_FILE)" && exit 1)
	@echo "Compiling RTL..." | tee -a $(LOG_FILE)
	@$(VLOG) -sv $(INCLUDES) -work $(WORK) \
		$(RTL_SOURCES) >> $(LOG_FILE) 2>&1 || \
		(echo "ERROR: RTL compilation failed. See $(LOG_FILE)" && exit 1)
	@echo "Compiling testbench..." | tee -a $(LOG_FILE)
	@$(VLOG) -sv $(INCLUDES) -work $(WORK) \
		$(TB_SOURCE) >> $(LOG_FILE) 2>&1 || \
		(echo "ERROR: TB compilation failed. See $(LOG_FILE)" && exit 1)
	@echo "Compilation completed successfully" | tee -a $(LOG_FILE)
	@echo ""

# Run simulation
run: compile
	@echo "======================================================================" | tee -a $(LOG_FILE)
	@echo "  Simulation Started: $$(date)" | tee -a $(LOG_FILE)
	@echo "======================================================================" | tee -a $(LOG_FILE)
	@echo "Running Result Packing simulation..." | tee -a $(LOG_FILE)
	@$(VSIM) -c -do "run -all; quit -force" $(WORK).$(TOP) >> $(LOG_FILE) 2>&1 || \
		(echo "ERROR: Simulation failed. See $(LOG_FILE)" && exit 1)
	@echo "" | tee -a $(LOG_FILE)
	@echo "======================================================================" | tee -a $(LOG_FILE)
	@echo "  Simulation Completed: $$(date)" | tee -a $(LOG_FILE)
	@echo "======================================================================" | tee -a $(LOG_FILE)
	@echo "" | tee -a $(LOG_FILE)
	@echo "Extracting test summary..." | tee -a $(LOG_FILE)
	@grep "PASS\|FAIL" $(LOG_FILE) | grep "\[TB\]" || echo "Warning: Could not find test results"
	@echo ""
	@echo "Full log available in: $(LOG_FILE)"

# Clean
clean:
	@echo "Cleaning simulation files..."
	@rm -rf $(WORK)
	@rm -f transcript
	@rm -f *.wlf
	@rm -f $(LOG_FILE)
	@rm -f *.vcd
	@rm -f *.asdb
	@rm -f *.tmp
	@echo "Clean complete"
